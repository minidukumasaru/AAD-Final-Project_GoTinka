<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: url('https://source.unsplash.com/1600x900/?sunset,city') no-repeat center center/cover;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .form-container {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 10px;
            color: white;
            width: 400px;
        }
        .form-container input,
        .form-container select {
            background: #222;
            color: white;
            border: none;
        }
        .form-container input:focus,
        .form-container select:focus {
            background: #333;
            color: white;
            border: none;
            outline: none;
            box-shadow: none;
        }
        .btn-primary, .btn-warning, .btn-danger, .btn-info {
            width: 48%;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="form-container">
    <h3 class="text-center">Manage Offer</h3>
    <form id="offerForm">
        <div class="mb-3">
            <label class="form-label">Offer Name</label>
            <input type="text" class="form-control" id="offerName" placeholder="Enter offer name">
        </div>
        <div class="mb-3">
            <label class="form-label">Discount Percentage</label>
            <input type="number" class="form-control" id="discountPercentage" placeholder="Enter discount percentage">
        </div>
        <div class="mb-3">
            <label class="form-label">Valid From</label>
            <input type="date" class="form-control" id="validFrom">
        </div>
        <div class="mb-3">
            <label class="form-label">Valid Until</label>
            <input type="date" class="form-control" id="validUntil">
        </div>
        <div class="mb-3">
            <label class="form-label">Package</label>
            <select class="form-select" id="packageName">
                <option selected>Select a package</option>
            </select>
        </div>
        <label class="form-label">OfferId</label>
        <input type="text" class="form-control" id="offerId">
        <label class="form-label">PackageId</label>
        <input type="text" class="form-control" id="packageId">
        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
            <button type="button" class="btn btn-warning" onclick=" deleteOffer()">Delete</button>
            <button type="button" class="btn btn-warning" onclick="viewOffers()">View</button>
        </div>
    </form>
    <!-- Package List Cards -->
    <div class="card-container" id="offerList">
        <!-- Dynamically generated package cards will appear here -->
    </div>
</div>
<script src="assets/js/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let authToken = localStorage.getItem("jwt_token");
    loadAllPackageNames();
    viewOffers();

    function loadAllPackageNames() {
        $.ajax({
            url: "http://localhost:8080/api/v1/packages/getNames",
            method: "GET",
            dataType: "json",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: (resp) => {
                console.log("API Response:", resp); // Debugging

                // Check if `resp.data` is an array
                if (!Array.isArray(resp.data)) {
                    console.error("Error: Response data is not an array", resp);
                    return;
                }

                let nameDropdown = $("#packageName");

                // Loop through `resp.data`
                resp.data.forEach(name => {
                    nameDropdown.append(`<option value="${name}">${name}</option>`);
                });
            },
            error: (err) => {
                console.error("Error loading package names:", err);
            }
        });
    }

    $("#packageName").change(function () {
        let selectedName = $(this).val();
        if (selectedName) {
            $.ajax({
                url: `http://localhost:8080/api/v1/packages/getPackageId/${selectedName}`,
                method: "GET",
                dataType: "json",
                headers: { "Authorization": `Bearer ${authToken}` },
                success: function (resp) {
                    console.log("Selected Name Data Response:", resp); // Debugging output

                    if (resp && resp.data) {
                        $("#packageId").val(resp.data); // Set the credit ID field
                    } else {
                        $("#packageId").val("");  // Clear input if no data found
                    }
                },
                error: function (error) {
                    console.error("Error fetching selected name details:", error);
                }
            });
        } else {
            console.log("No name selected.");
            $("#packageId").val("");  // Clear input if no bundle selected
        }
    });

    // Save or Update Offer (Create or Update)
    $("#offerForm").submit(function (event) {
        event.preventDefault();

        let offerId = $("#offerId").val().trim();
        let offerName = $("#offerName").val().trim();
        let discountPercentage = $("#discountPercentage").val().trim();
        let validFrom = $("#validFrom").val().trim();
        let validUntil = $("#validUntil").val().trim();
        let packageId = $("#packageId").val().trim();

        if (!offerName || !discountPercentage || !validFrom || !validUntil || !packageId) {
            alert("Please fill in all required fields!");
            return;
        }

        let apiUrl = "http://localhost:8080/api/v1/offers/save";
        let methodType = "POST";
        let requestData = { offerName, discountPercentage, validFrom, validUntil, packageId };

        if (offerId) { // If offerId exists, update instead of saving
            apiUrl = `http://localhost:8080/api/v1/offers/update/${offerId}`;
            methodType = "PUT";
            requestData.offerId = offerId;
        }

        $.ajax({
            url: apiUrl,
            type: methodType,
            contentType: "application/json",
            data: JSON.stringify(requestData),
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function () {
                alert(offerId ? "Offer updated successfully!" : "Offer saved successfully!");
                clearOfferForm();
                viewOffers();
            },
            error: function (xhr) {
                alert("Operation failed: " + xhr.responseText);
            },
        });
    });

    // Delete Offer
    function deleteOffer() {
        let offerId = $("#offerId").val().trim();
        if (!offerId) {
            alert("Please select an offer to delete.");
            return;
        }
        if (!confirm("Are you sure you want to delete this offer?")) {
            return;
        }

        $.ajax({
            url: `http://localhost:8080/api/v1/offers/delete/${offerId}`,
            type: "DELETE",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function () {
                alert("Offer deleted successfully!");
                clearOfferForm();
                viewOffers();
            },
            error: function (xhr) {
                alert("Delete failed: " + xhr.responseText);
            },
        });
    }

    // View Offers
    function viewOffers() {
        $.ajax({
            url: "http://localhost:8080/api/v1/offers/getAll",
            type: "GET",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function (response) {
                $("#offerList").empty();



                        response.data.forEach(offer => {
                            console.log("Offer ID:", offer.offerId);
                            console.log("Package ID:", offer.packageId);
                    $("#offerList").append(`
                <div class="offer-card" onclick="fillOfferForm(${offer.offerId}, '${offer.offerName}', '${offer.discountPercentage}', '${offer.validFrom}', '${offer.validUntil}', '${offer.packageId}')">
                    <h5>${offer.offerName}</h5>
                    <p>Discount: ${offer.discountPercentage}%</p>
                    <p>Package Id: ${offer.packageId}</p>
                    <p>Valid From: ${offer.validFrom}</p>
                    <p>Valid Until: ${offer.validUntil}</p>
                </div>
            `);
                        });
            },
            error: function (xhr) {
                alert("Failed to fetch offers.");
            },
        });
    }

    // Fill Offer Form when clicking an offer
    function fillOfferForm(offerId, offerName, discountPercentage, validFrom, validUntil, packageId) {
        $("#offerId").val(offerId);
        $("#offerName").val(offerName);
        $("#discountPercentage").val(discountPercentage);
        $("#validFrom").val(validFrom);
        $("#validUntil").val(validUntil);
        $("#packageId").val(packageId);
    }

    // Clear Offer Form
    function clearOfferForm() {
        $("#offerId").val("");
        $("#offerName").val("");
        $("#discountPercentage").val("");
        $("#validFrom").val("");
        $("#validUntil").val("");
        $("#packageId").val("");
    }

</script>
</body>
</html>
